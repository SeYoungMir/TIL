# 2. 크롤러 설계
## 2. 크롤러가 가지는 각각의 처리를 설계할 때 주의 사항
### 1. 설계가 필요한 부분
- 대상 사이트의 데이터 제공 형식이 웹 API, 피드, HTML이라면 고전적인 처리 과정을 따름.
- 이는 수집>분석>추출>가공>저장>출력의 방식
- 여기서 출력 결과로 무엇이 필요한가가 목적
- 표로 하면 다음과 같음
<table>
    <tr>
        <th>공정</th>
        <th>내용</th>
    </tr>
    <tr>
        <td>수집</td>
        <td>네트워크에 있는 데이터에 요청, 내부에 추가적인 링크가 있다면 수집, 해당 링크들에 대해 추가적인 요청</td>    
    </tr>
    <tr>
        <td>분석</td>
        <td>파싱, 텍스트 데이터를 구조화된 데이터로 변환</td>    
    </tr>
    <tr>
        <td>추출</td>
        <td>필요한 데이터를 특정 키를 기반으로 추출, 스크레이핑 또는 정규 표현식으로 사용해서 추출</td>
    </tr>
    <tr>
        <td>가공</td>
        <td>사용 형태에 맞게 추출한 데이터에서 노이즈 제거, 정규화, 이미지 처리등을 함</td>    
    </tr>
    <tr>
        <td>저장</td>
        <td>수집한 페이지와 추출하고 가공한 데이터를 데이터 저장소에 저장</td>    
    </tr>
</table>

### 2. 네트워크 요청
1. 간격 설정하기
   - 같은 사이트에 짧은 시간동안 많은 요청을 하면 정적인 페이지로 구성된 사이트라도 부하가 걸림.
   - 만약 동적인 페이지로 구성된 사이트라면 매우 큰 부하가 걸림
   - 1초에 1번 정도의 요청이 좋음
2. 타임아웃
   - 요청한 사이트로부터 응답이 오지 않는 경우, 타임아웃을 설정해야함. 크롤링 하는 시점에 갑자기 사이트에 큰 부하가 생긴다거나 하는 경우에 일정 시간 응답이 없다면 데이터 수집을 멈추는 것이 좋음
3. 재시도
   - 일반적인 사이트는 큰 문제가 없는데도 오류를 응답하는 경우가 있음
   - 이는 크롤러가 요청했을 때에만 발생한 오류일 수 있음.
   - 이 때는 재시도(retry)하는 것이 좋음
   - 만약 재시도를 하는 경우, 실제로 문제가 발생한 페이지에 다시 요청을 보내는 것은 사잍트에 부하를 줄 수 있으므로 1~3회 정도의 횟수 제한을 거는 것이 좋음
   - 재시도 간격도 중요. Exponential Backoff라고 부르는 방법을 사용하는 것이 좋으며, 이는 통신에 실패하는 횟수가 많아질수록 간격을 늘리는 알고리즘임.
   - 2의 n제곱 간격으로 재시도하면 부하를 적게 줄 수 있음
### 3. 파싱(분석)
1. 문자 코드
   - 웹 API 또는 RSS 피드는 대부분 UTF-8로 작성, HTML 소스 코드는 다양한 문자 코드로 작성된 경우가 많으므로 주의.
   - 예를 들어 EUC-KR로 작성된 페이지를 UTF-8로 읽어들이면 문자가 깨짐
   - 응답 헤더 내부의 Content-Encoding 헤더에 문자 코드가 나와있는 경우엔 이를 기반으로 문자 코드를 알 수 있으나, 문자 코드가 나와 있지 않거나, 불완전한 경우도 많음
   - 가장 좋은 방법은 사이트별로 문자 코드를 미리 확인, 이를 기반으로 처리
   - 문자 코드 판별 라이브러리 사용하는 방법도 있음
2. HTML/XML 파싱
   - 웹 페이지 중에는 태그가 잘못 구성되어 있거나 속성 값에 큰 따옴표가 기입되지 않은 경우가 있음. 일반적으로 라이브러리가 이러한 부분을 보완, 보완되지 않는 경우엔 별도 프로그램 사용
   - 유명한 오픈소스로는 HTML Tidy 가 있음
   - 파이썬의 대표적인 HTML/XML 파싱 라이브러리는 Beautiful Soup과 lxml로, 보완을 위한 기능이 있지만 라이브러리 사용 시 문제 발생하면 HTML/XML에 문제가 있을 가능성도 있음
3. JSON 디코드
   - 현대적인 프로그래밍 언어는 기본적으로 JSON 디코더 제공, JSON 디코더 사용 시 프로그래밍 언어에 있는 딕셔너리 자료형(연관 배열) 형태로 데이터 변환 가능
   - 웹 API 중에는 아직도 XML 형식으로 데이터 응답해주는 곳도 많지만, 새로 만들어지는 대부분의 웹 API는 JSON 형식으로 데이터 응답, XML 파싱은 조금 복잡하므로 JSON 형식 데이터를 응답받는다면 적극적으로 활용 추천